{% extends "home_base.html" %}
{% load seahub_tags i18n %}

{% block sub_title %}{% trans "Libraries" %} - {% endblock %}

{% block extra_style %}
{% if need_guide %}
<style type="text/css">
#guide-for-new {
    padding: 0 20px;
    width: 450px;
}
#guide-for-new .icon-lightbulb {
    font-size:6em;
    color:#feac74;
}
#guide-for-new .txt {
    margin-left:6.4em;
}
</style>
{% endif %}
<style type="text/css">
/* lib view */
.repo-file-list .dirent-name {
    width:300px;
}
.repo-file-list .dirent-size {
    width:104px;
}
.repo-file-list .dirent-update {
    width:103px;
}
.repo-file-list .dirent-op {
    width:100px;
}
</style>
{% endblock %}

{% block cur_my_lib %}tab-cur{% endblock %}

{% block right_panel %}
{% include "snippets/my_owned_repos.html" %}

{% url 'share_repo' as repo_share_url %}
{% with post_url=repo_share_url %}
{% include "snippets/repo_share_form.html" %}
{% endwith %}

{% include "snippets/repo_create_form.html" %}

{% if need_guide %}
<div id="guide-for-new" class="hide">
    <span class="icon-lightbulb fleft"></span>
    <div class="txt">
        <h3>{% trans "Welcome to Seafile!" %}</h3>
        {% if user.permissions.can_add_repo %}
        <p>{% trans "Seafile organizes files into libraries. Each library can be synced and shared separately. We have created a personal library for you. You can create more libraries later." %}</p>
        {% else %}
        <p>{% trans "Seafile organizes files into libraries. Each library can be synced and shared separately. Howerver, since you are a guest user now, you can not create libraries." %}</p>
        {% endif %}
        <button class="simplemodal-close" style="margin:8px 0 0 0;">{% trans "Close" %}</button>
    </div>
</div>
{% endif %}

{% if ENABLE_SUB_LIBRARY and sub_lib_enabled %}
<form id="sublib-create-form" class="file-choose-form hide">
    <h3>{% trans "Choose a directory:" %}</h3>
    <div class="dir-tree-cont">
        <img src="{{MEDIA_URL}}img/loading-icon.gif" alt="" class="loading-tip" />
    </div>
    <input type="hidden" name="dst_repo" value="" />
    <input type="hidden" name="dst_path" value="" />
    <p class="error hide"></p>
    <input type="button" value="{% trans "Submit" %}" class="submit" />
    <button class="simplemodal-close">{% trans "Cancel"%}</button>
</form>
{% endif %}

{# for repo view #}
<div id="repo-file-list" class="hide">
    <div class="repo-file-list-topbar">
        <p class="path fleft"></p>
        <div class="repo-op fright"></div>
        <div class="clear"></div>
    </div>
    <table class="repo-file-list">
        <tr>
            <th class="select">
                <span class="checkbox"><input type="checkbox" class="checkbox-orig" /></span>
            </th>
            <th class="star"></th>
            <th class="dirent-icon"></th>
            <th><span class="dirent-name">{% trans "Name"%} <span id="by-name" class="icon-caret-up cspt"></span></span></th>
            <th class="dirent-size">{% trans "Size"%}</th>
            <th class="dirent-update">{% trans "Last Update" %} <span id="by-time" class="icon-caret-down cspt"></span></th>
            <th class="dirent-op">{% trans "Operations"%}</th>
        </tr>
    </table>
    <img class="loading-tip" src="{{MEDIA_URL}}img/loading-icon.gif" alt="{% trans 'Loading...' %}" />
</div>
{% endblock %}

{% block extra_script %}{{block.super}}
<script type="text/javascript">
{% if need_guide %}
$(function() {$('#guide-for-new').modal({appendTo: '#main', focus:false});});
{% endif %}
{% include "snippets/myhome_extra_script.html" %}
var cur_tab = $('.ui-tabs-selected .a');    
var lib_create_btn = $('#repo-create'),
    sublib_create_btn = $('#sub-lib-create');
// for 'long language' such as german
if (sublib_create_btn.text().length > 15) { // 'new Sub-library'.length is 15
    $('span', sublib_create_btn).text(trimFilename(sublib_create_btn.text(),14));;
}

// for initial state
if (cur_tab.attr('id') == 'mylib-tab') {
    lib_create_btn.removeClass('hide');
}
if (cur_tab.attr('id') == 'sublib-tab') {
    sublib_create_btn.removeClass('hide');
}
$('#mylib-tab').click(function() {
    lib_create_btn.removeClass('hide');
    sublib_create_btn.addClass('hide');
});
$('#sublib-tab').click(function() {
    lib_create_btn.addClass('hide');
    sublib_create_btn.removeClass('hide');
});
$('#shared-lib-tab, #grp-lib-tab').click(function() {
    lib_create_btn.addClass('hide');
    sublib_create_btn.addClass('hide');
});
{% if ENABLE_SUB_LIBRARY and sub_lib_enabled %}
var sublib_create_form = $('#sublib-create-form');
sublib_create_btn.click(function() {
    var dir_tree_cont = $('.dir-tree-cont', sublib_create_form);
    sublib_create_form.modal();
    $.ajax({
        url: '{% url 'get_my_unenc_repos' %}',
        cache: false,
        dataType: 'json',
        success: function(data) {
            var file_tree = new FileTree();
            var repos = file_tree.format_repo_data(data);
            if (repos.length > 0) {
                file_tree.renderDirTree(dir_tree_cont.data('site_root', '{{SITE_ROOT}}'), sublib_create_form, repos);
            } else {
                dir_tree_cont.html('<p class="error">' + "{% trans "You don't have any library at present" %}" + '</p>');
            }   
        },  
        error: function(jqXHR, textStatus, errorThrown) {
            var error;
            if (jqXHR.responseText) {
                error = $.parseJSON(jqXHR.responseText).error;
            } else {
                error = "{% trans "Failed. Please check the network." %}";
            }
            dir_tree_cont.html('<p class="error">' + error + '</p>');
        }   
    }); 
});
$('.submit', sublib_create_form).click(function() {
    var ori_repo_id = $('[name="dst_repo"]', sublib_create_form).val();    
    var path = $('[name="dst_path"]', sublib_create_form).val();    
    
    if (!path || path == '/') {
        $('.error', sublib_create_form).html("{% trans "Please choose a directory" %}").removeClass('hide');
        return false;
    } 
    
    // path ends with '/', rm it here 
    path = path.substr(0, path.length - 1); 
    $.ajax({
        url: '{{SITE_ROOT}}ajax/repo/' + ori_repo_id + '/dir/sub_repo/?p=' + e(path),
        dataType: 'json',
        success: function(data) {
            location.reload();
        },
        error: function(xhr, textStatus, errorThrown) {
            var err;
            if (xhr.responseText) {
                err = jQuery.parseJSON(xhr.responseText).error;
            } else {
                err = "{% trans "Failed. Please check the network." %}";
            }
            $('.error', sublib_create_form).html(err).removeClass('hide');
        }
    });
    return false;
});
{% endif %}
{% include "snippets/repo_create_js.html" with post_url=repo_create_url %}

// for 'lib' view
// global var
var no_file_op_popup = true;
var popup_tr;

// hide 'hidden-op' popup
$(document).click(function(e) {
    var target =  e.target || event.srcElement;
    if (!no_file_op_popup &&
        !$('.more-op-icon, .hidden-op').is(target) &&
        !$('.hidden-op').find('*').is(target)) {
        $('.hidden-op').addClass('hide');
        no_file_op_popup = true;
        if (!popup_tr.find('*').is(target)) {
            popup_tr.removeClass('hl').find('.repo-file-op').addClass('vh'); // clicked place: the first tr, place out of the table
            $('.repo-file-list tr:gt(0)').each(function() { // when other tr is clicked
                if ($(this).find('*').is(target)) {
                    $(this).addClass('hl').find('.repo-file-op').removeClass('vh');
                }
            });
        }
    }
});

</script>
{% endblock %}

{% block app_page_script %}
<script type="text/javascript">
$('.lib-link').click(function() {
    app.router.navigate($(this)[0].pathname.substr(app.config.siteRoot.length - 1), {trigger: true});
    $('#tabs').hide();
    $('#repo-file-list').show();
    //console.log($(this)[0].pathname.substr(app.config.siteRoot.length - 1));
    return false;
});
//app.pages.myhome = {};
</script>
<script type="text/template" id="path-template">
    <a href="<%= site_root %>lib/<%= repo_id %>/dir/" class="path-link normal"><%= repo_name %></a> /
    <% for (var i = 0,len = path_list.length; i < len; i++) { %>
        <% if (i == len - 1) { %>
            <% print(path_list[i] + ' /'); %>
        <% } else { %>
            <a href="<%= site_root %>lib/<%= repo_id %>/dir/<% print(path_list.slice(0, i+1).join('/')); %>/" class="path-link normal"><%= path_list[i] %></a> /
        <% } %>
    <% } %>
</script>
<script type="text/template" id="libop-template">
    <% if (user_perm == 'rw') { %>
        <% if (no_quota) { %>
    <button id="upload-file" class="op-btn">{% trans "Upload" %}</button>
        <% } else { %>
    <div id="upload-file" class="op-btn upload-file-btn">
        <span>{% trans "Upload"%}</span>
        <input type="file" name="file" multiple />
    </div>
    {% if enable_upload_folder %}
    <ul id="upload-menu" class="hide">
        <li class="item">
        <span>{% trans "Upload Files" %}</span>
        <input type="file" name="file" multiple />
        </li>
        <li class="item">
        <span>{% trans "Upload Folder" %}</span>
        <input type="file" name="file" multiple directory webkitdirectory />
        </li>
    </ul>
    {% endif %}
        <% } %>
    <button id="add-new-dir" class="op-btn">{% trans "New Directory" %}</button>
    <button id="add-new-file" class="op-btn">{% trans "New File" %}</button>
    <% } %>

    <% if (path != '/' && !encrypted) { %>
    <button class="op-btn" id="share-cur-dir" data-link="<%= share.link %>" data-token="<%= share.token %>" data-upload-link="<%= share.upload_link %>" data-upload-token="<%= share.upload_token %>" data-url="{% url 'get_shared_link' %}?repo_id=<% print(e(repo_id)); %>&type=d&p=<% print(e(path)); %>" data-upload-url="{% url 'get_shared_upload_link' %}?repo_id=<% print(e(repo_id)); %>&p=<% print(e(path)); %>">{% trans "Share" %}</button>
    <% } %>
</script>
<script type="text/template" id="dirent-template">
    <% if (dirent.is_dir) { %>
            <td class="select">
                <span class="checkbox"><input type="checkbox" class="checkbox-orig" /></span>
            </td>
            <td class="star"></td>
            <td class="dirent-icon"><img src="<%= media_url %>img/folder-icon-24.png" alt="{% trans "Directory icon" %}" /></td>
            <td>
                <span class="dirent-name"><a href="<%= site_root %>lib/<%= repo_id %>/dir/<% print(dirent.p_dpath.substr(1) + '/'); %>" class="dir-link normal"><%= dirent.obj_name %></a></span>
            </td>
            <td class="dirent-size"></td>
            <td class="dirent-update">
                <% if (dirent.last_modified) { %>
                    <% print(dirent.last_update); %>
                <% } else { %>
                    <% print("{% trans "Fetch failed" %}"); %>
                <% } %>
            </td>
            <td class="dirent-op">
                <div class="repo-file-op vh">
                    <div class="displayed-op">
                        <a class="op download" href="<%= site_root %>repo/download_dir/<%= repo_id %>/?p=<% print(e(dirent.p_dpath)); %>" title="{% trans "Download" %}"><img src="<%= media_url %>img/download.png" alt="" /></a>
                        <% if (!repo_encrypted) { %>
                        <a class="op share" href="#" data-link="<%= dirent.sharelink %>" data-token="<%= dirent.sharetoken %>" data-upload-link="<%= dirent.uploadlink %>" data-upload-token="<%= dirent.uploadtoken %>" title="{% trans "Share" %}"><img src="<%= media_url %>img/share_20.png" alt="" /></a>
                        <% } %>
                    </div>
                    <% if (user_perm == 'rw') { %>
                    <img src="<%= media_url %>img/dropdown-arrow.png" title="{% trans "More operations" %}" alt="{% trans "More operations" %}" class="more-op-icon cspt" />
                    <ul class="hidden-op hide">
                        <li><a class="op del" href="#">{% trans "Delete" %}</a></li>
                        <li><a class="op rename" href="#">{% trans "Rename" %}</a></li>
                        <li><a class="op mv" href="#">{% trans "Move" %}</a></li>
                        <li><a class="op cp" href="#">{% trans "Copy" %}</a></li>
                    </ul>
                    <% } %>
                </div>
            </td>
    <% } else { %>
            <td class="select">
                <span class="checkbox"><input type="checkbox" class="checkbox-orig" /></span>
            </td>
            <td class="star alc">
                <% if (dirent.starred) { %>
                    <span title="{% trans "starred" %}" class="icon-star file-star"></span>
                <% } else { %>
                    <span title="{% trans "unstarred" %}" class="icon-star-empty file-star"></span>
                <% } %>
            </td>
            <td class="dirent-icon">
                <% if (dirent.is_img) { %>
                    <% if (dirent.thumbnail_src) { %>
                        <img class="thumbnail" src="<%= dirent.thumbnail_src %>" alt="" />
                    <% } else { %>
                        <img class="not-thumbnail" src="<%= media_url %>img/file/<%= dirent.file_icon %>" alt="" />
                    <% } %>
                <% } else { %>
                    <img src="<%= media_url %>img/file/<%= dirent.file_icon %>" alt="" />
                <% } %>
            </td>
            <td>
                <span class="dirent-name"><a class="normal" href="<%= site_root %>lib/<%= repo_id %>/file<% print(path + dirent.obj_name); %>" target="_blank"><%= dirent.obj_name %></a></span>
            </td>
            <td class="dirent-size"><%= dirent.file_size %></td>
            <td class="dirent-update">
                <% if (dirent.last_modified) { %>
                    <% print(dirent.last_update); %>
                <% } else { %>
                    <% print("{% trans "Fetch failed" %}"); %>
                <% } %>
            </td>
            <td class="dirent-op">
                <div class="repo-file-op vh">
                    <div class="displayed-op">
                        <a class="op download" href="<%= site_root %>repo/<%= repo_id %>/<%= dirent.obj_id %>/download/?p=<% print(e(path+dirent.obj_name)); %>" title="{% trans "Download" %}"><img src="<%= media_url %>img/download.png" alt="" /></a>
                        <% if (!repo_encrypted) { %>
                        <a class="op share" href="#" data-link="<%= dirent.sharelink %>" data-token="<%= dirent.sharetoken %>" title="{% trans "Share" %}"><img src="<%= media_url %>img/share_20.png" alt="" /></a>
                        <% } %>
                    </div>
                    <% if (user_perm == 'rw') { %>
                    <img src="<%= media_url %>img/dropdown-arrow.png" title="{% trans "More Operations"%}" alt="{% trans "More Operations"%}" class="more-op-icon cspt" />
                    <ul class="hidden-op hide">
                        <li><a class="op del" href="#">{% trans "Delete" %}</a></li>
                        <li><a class="op rename" href="#">{% trans "Rename" %}</a></li>
                        <li><a class="op mv" href="#">{% trans "Move" %}</a></li>
                        <li><a class="op cp" href="#">{% trans "Copy" %}</a></li>
                        <li><a class="op file-update" href="#">{% trans "Update"%}</a></li>
                        <li><a class="op file-history" href="<%= site_root %>repo/file_revisions/<%= repo_id %>/?p=<% print(e(path+dirent.obj_name)); %>" target="_blank">{% trans "History" %}</a></li>
                    </ul>
                    <% } %>
                </div>
            </td>
    <% } %>
</script>
{% endblock %}
